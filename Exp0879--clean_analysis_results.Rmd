---
title: "Step 2, Notebook 2: Assembling Fragment data"
output: html_notebook
---
This notebook takes raw data and fits results, and cleans results for further analysis. 
It contains the second step of this pipeline. 
Specifically:
- establish cutoffs for "bad" fits and "bad" curves, and remove them 
- ensure tma1 and tma2 are all correcty grouped

Perform in previous notebook Exo0879--clean_and_fit.Rmd:
- Pooled all data
- Performed fitting analysis

To be performed by later notebooks:
- Make plots
- Make tables
- Calculate relevant statistics

```{r}
library(tidyverse)

convert_numerics <- function( vec ) {
  
            if(all(varhandle::check.numeric(vec))){
                # convert the vector to numeric
                vec <- as.numeric(vec)
            }
            vec
        }

get_upper_whisker <- function(IQR_coef = 1.5, quant_col) {
  IQR_val <- stats::IQR({{quant_col}}) # <- (quantile({{quant_col}}, probs = 0.75) - quantile({{quant_col}}, probs = 0.25))
  top_hinge <- quantile({{quant_col}}, probs = 0.75)
  
  top_hinge + IQR_coef * IQR_val
}


# well is unique here! use that
merge_elements <- function( in_list ) { # this runction could use some work to be more flexible
  
   df_list <- c("tm_models_all", "df_BIC", "model")
    model_list <- c("s1_list", "s1_d_list", "s2_list", "s2_d_list")
  
  out <- list()
  
  for (df_element in df_list) {

    int <- lapply(model_list, function(x) { in_list$fits[[x]][[df_element]] %>%
                                            mutate(x, which_model = x)})  %>%
          # lapply( . , function(x) { mutate(x, which_model = model_list)} ) %>%
              bind_rows() # bind together extracted df_element from all four models

    out <- list(out, int) # add that df_element to a list
    
  }

 dRFU_tmas  <- lapply(model_list, function(x) in_list$fits[["df_tms"]]) %>%
                bind_rows() %>%
                mutate(which_model = "dRFU") %>%
                rename(mean_tma1 = "dRFU_tma") %>%
                select(well, which_model, condition, mean_tma1)

 #df_resids <- out[[3]]

out_list <- list("model_tmas" = out[[1]][[1]][[2]],
                 "model_results" = out[[2]],
                 "resid" = out[[2]] %>% select(variable, which_model, resids) %>% unnest( cols = c(resids) ),
                 "dRFU_tmas" = dRFU_tmas,
                 "df_BIC" = out[[1]][[2]] )

}
```

```{r}
test_extract<- lapply(all_processed[1], merge_elements)

test_extract$Exp0827$model_tmas

test_extract$Exp0827$resid$which_model %>% table()

results_extracted <- lapply(all_processed, merge_elements)

results_extracted$Exp0827$model_tmas
```

Read in analysis results
```{r}
all_processed <- readRDS("analyzed/Exp0879--20200912_all_analyzed_results.rds") # all analysis results
dfs_protein_EBPS <- readRDS("analyzed/Exp0879--20200912_all_dfs_list_no_empties.rds") # all raw data
dfs_protein_TAMRA <- readRDS("analyzed/Exp0879--20200912_all_dfs_as_input_to_analysis.rds") # no EBPs and TAMRA only, fed directly to fitting function

###### Clean up analysis results  ----------
results_extracted <- lapply(all_processed, merge_elements)
```


Create raincloud plot theme
```{r}
# https://micahallen.org/2018/03/15/introducing-raincloud-plots/
library(PupillometryR) # has geom_flat_violin

raincloud_theme = theme(  # set publication-quality text sizes
                          text = element_text(size = 14),
                          
                          plot.title = element_text(lineheight=.8, face="bold", size = 16),
                          axis.title.x = element_text(size = 16),
                          axis.title.y = element_text(size = 16),
                          
                          axis.text = element_text(size = 14),
                          #axis.text.x = element_text(angle = 90, vjust = 0.5),
                          
                          # lenengd aesthetics (new feautres for legen aesthetics are available!)
                          legend.title=element_text(size=16),
                          legend.text=element_text(size=16),
                          legend.position = "right",

                          # remove gridlines; they don't add much to violin plots
                          panel.grid.minor = element_blank(),
                          panel.grid.major = element_blank(),
                          
                          # make whitespace transparent
                          panel.background = element_rect(fill = "transparent",colour = NA),
                          plot.background = element_rect(fill = "transparent",colour = NA)
                          )
```


Highlighting poor fits/odd curves

Criteria 1: By high initial fluorecence
Make raincloud plots to compare starting RFU
```{r}
# Bind all data together, retaining only the columns which will exist in all experiments
all_TAMRA <- dfs_protein_TAMRA %>%
              map(. , ~select(.x, c(Temperature, variable, plate_number, value, value_norm)) ) %>%
              bind_rows()

# isolate 25 C data and outliers
RFU_25 <- all_TAMRA %>%
          filter(Temperature == 25) %>%
          group_by(plate_number) %>%
          mutate( outlier = if_else(value > get_upper_whisker(IQR_coef = 1.5, quant_col = value), # identify outliers
                                   true = "Rejected",
                                   false = "Retained") )

RFU_25_rejects <- RFU_25$variable %>% unique()

######### Each experiment individually  ------------------
g <- RFU_25 %>%
          ggplot(data = . , 
                 aes(x = plate_number, 
                     y = value, 
                     fill = plate_number, 
                     group = plate_number)) +
          
          geom_flat_violin(position = position_nudge(x = .2, y = 0), 
                           alpha = .8) +
          
          geom_point(aes(shape = outlier,
                         color = plate_number), 
                     position = position_jitter(width = .15), 
                     size = .5, 
                     alpha = 0.8) +
  
          geom_boxplot(width = .15,  outlier.shape = 19, alpha = 0.5, coef = 1.5) +
  
          scale_shape_manual(values = c(4,16) )+
          scale_y_continuous( trans = "log2" ) +

          theme_bw() +
          raincloud_theme +
          labs(title = "Some day-to-day variation in starting RFUs\nmotivates experiment-specific threshholding", 
               y = "RFU (TAMRA 535/580 nm)",
               x = "Plate Number") +
          
          coord_flip() +
  
          guides(fill="none", 
                 color = "none",
                 shape = guide_legend( title = "",
                                       labels = paste("long", c(5, 10)),
                                       labels = c(`FALSE` = "Retained", `TRUE` = "Rejected"),
                                       override.aes = list(size = 5),
                                       legend.justification = c("right", "top")
                                       #legend.position = c(.95, .95)
                                       )
                 ) 

# Save one version with the experiment numbers
g_expnum <- g + scale_x_discrete( labels = all_TAMRA$plate_number %>% unique() %>% extract_numeric() %>% substr(0, 3) )

# Save one version with consecutive numbers
g_order_num <- g + scale_x_discrete( labels = 16:1 )

ggsave("cleaned_analysis/Exp0879--20200913_starting_RFU_all_experiment_exp_numbered.pdf", g_expnum, width = 7, height = 10)
ggsave("cleaned_analysis/Exp0879--20200913_starting_RFU_all_experiment_consec_numbered.pdf", g_order_num, width = 7, height = 10)

######### All experiments pooled ------------------ 
g_summary <- RFU_25 %>%
  ggplot(data = . , 
         aes(x = 0, 
             y = value)) +
  
  geom_flat_violin(position = position_nudge(x = .2, y = 0), 
                   alpha = .8) +
  
  geom_point(position = position_jitter(width = .15), 
             size = .5, 
             alpha = 0.5) +
  
    geom_boxplot(width = .1,  outlier.shape = 19, alpha = 0.5) +
  
  scale_y_continuous(trans = "log2") +
  
  theme_bw() +
  raincloud_theme +
  theme(axis.title.y = element_blank()) +
  labs(title = "All experiments pooled", 
       y = "RFU (TAMRA 535/580 nm)") +
  
  coord_flip()

ggsave("cleaned_analysis/Exp0879--20200913_starting_RFU_pooled.pdf", g_summary, width = 7, height = 3)
```


Criteria 2: by high residuals of the fits
```{r}
##### Isolate just the residuals and bind into single data frame
all_resids <- lapply(results_extracted, `[[`,  j = "resid" ) %>%
               bind_rows() %>%
              separate(variable, into = c("well", "channel", "plate_number"), remove = FALSE)

sum_resids <- all_resids %>% 
              unite(plate_number_model, c(plate_number, which_model), remove = FALSE) %>%
              #filter(which_model == "s2_list") %>%
              group_by(which_model) %>%
              mutate(sum_abs_resid = sum(abs(resid))) %>%
              select(plate_number_model, which_model, variable, plate_number, sum_abs_resid) %>%
              ungroup() %>%
              distinct() %>%
              rename(value = sum_abs_resid) %>%

              group_by(plate_number) %>%
               mutate( outlier = if_else(value > get_upper_whisker(IQR_coef = 1.5, quant_col = value), # identify outliers
                                   true = "Rejected",
                                   false = "Retained") )

sum_resid_rejects <- sum_resids$variable %>% unique()

######### Each experiment individually  ------------------
g <- sum_resids %>%
  # filter(plate_number == "Exp0827",
  #        which_model =="s1_list") %>%
          ggplot(data = . , 
                 aes(x = which_model, 
                     y = value, #x = plate_number, 
                     fill = which_model, 
                     group = which_model)) +
          
          geom_flat_violin(position = position_nudge(x = .2, y = 0), 
                           alpha = .8) +
          
          geom_point(aes(shape = outlier,
                         color = which_model), 
                     position = position_jitter(width = .15), 
                     size = .5, 
                     alpha = 0.8) +
  
          geom_boxplot(width = .15,  outlier.shape = 19, alpha = 0.5, coef = 1.5) +
  
          scale_shape_manual(values = c(4,16) )+
          #scale_y_continuous( trans = "log2" ) +

          theme_bw() +
          raincloud_theme +
          labs(title = "Some day-to-day variation in starting RFUs\nmotivates experiment-specific threshholding", 
               y = "RFU (TAMRA 535/580 nm)",
               x = "Plate Number") +
          
          coord_flip() +
  
          guides(fill="none", 
                 color = "none",
                 shape = guide_legend( title = "",
                                       labels = paste("long", c(5, 10)),
                                       labels = c(`FALSE` = "Retained", `TRUE` = "Rejected"),
                                       override.aes = list(size = 5),
                                       legend.justification = c("right", "top")
                                       #legend.position = c(.95, .95)
                                       )
                 ) +
            facet_wrap(~plate_number)

# Save one version with the experiment numbers
g_expnum <- g + scale_x_discrete( labels = all_TAMRA$plate_number %>% unique() %>% extract_numeric() %>% substr(0, 3) )
g_expnum
# Save one version with consecutive numbers
g_order_num <- g + scale_x_discrete( labels = 16:1 )

# ggsave("cleaned_analysis/Exp0879--20200913_starting_RFU_all_experiment_exp_numbered.pdf", g_expnum, width = 7, height = 10)
# ggsave("cleaned_analysis/Exp0879--20200913_starting_RFU_all_experiment_consec_numbered.pdf", g_order_num, width = 7, height = 10)

######### All experiments pooled ------------------ 
g_summary <- RFU_25 %>%
  ggplot(data = . , 
         aes(x = 0, 
             y = value)) +
  
  geom_flat_violin(position = position_nudge(x = .2, y = 0), 
                   alpha = .8) +
  
  geom_point(position = position_jitter(width = .15), 
             size = .5, 
             alpha = 0.5) +
  
    geom_boxplot(width = .1,  outlier.shape = 19, alpha = 0.5) +
  
  scale_y_continuous(trans = "log2") +
  
  theme_bw() +
  raincloud_theme +
  theme(axis.title.y = element_blank()) +
  labs(title = "All experiments pooled", 
       y = "Total absolute residual of Model 3") +
  
  coord_flip()

# ggsave("cleaned_analysis/Exp0879--20200913_starting_RFU_pooled.pdf", g_summary, width = 7, height = 3)

```
Isolate data for all paper 1 componds 
Extract compound/layout information from the original dataframges
```{r}
paper1_cmpds_table <- readxl::read_excel("Exp0879--20200912_fragments_for_paper1.xlsx") %>%
                      rename(ZINC = ID) %>%
                       rename(compound = `Tube-label`)

paper1_cmpds <- paper1_cmpds_table$`Tube-label`

results_extracted$Exp0827$model_tmas[[2]]
all_model_tmas <- lapply(results_extracted, `[[`,  j = "model_tmas" ) %>%
                  bind_rows()

has_compound_conc_col <-  map( dfs_protein_TAMRA , ~"compound_conc" %in% names(.x)  ) %>% as_vector()

has_ZINC_col_only <-  map2( map( dfs_protein_TAMRA , ~"ZINC" %in% names(.x)  ) %>% as_vector(),
                            map(dfs_protein_TAMRA , ~!"compound" %in% names(.x)  ) %>% as_vector(),
                            all) %>% 
                      as_vector()

compound_col_added <- dfs_protein_TAMRA %>% 
                      .[has_ZINC_col_only] %>%
                       map(. , ~left_join(.x, paper1_cmpds_table %>% select(ZINC, compound))) #%>%

with_compound_col <- c(dfs_protein_TAMRA[!has_ZINC_col_only], compound_col_added)

has_compound_conc_col <- map( with_compound_col , ~"compound_conc" %in% names(.x)  ) %>% as_vector()


has_compound_col<- map( with_compound_col , ~"compound" %in% names(.x)  ) %>% as_vector()
has_compound_col

all_layouts <-with_compound_col %>%
                      .[has_compound_conc_col] %>%
                      map(. , ~select(.x, c(condition, compound, compound_conc)) ) %>%
                      map(. , ~mutate_all(.x, as.character)) %>%
                  
                               bind_rows()  %>%
                    mutate_all( . ,convert_numerics) %>% # this misses the compond conc column--is it because of decimal places??
                    mutate_at( . ,"compound_conc", as.numeric)

all_layouts
```
Combine the layout information with the tma information
```{r}
all_tmas <- lapply(results_extracted, `[[`,  j = "model_tmas" ) %>%
               bind_rows() %>%
               select(condition, mean_tma1, mean_tma2, which_model) %>%
                set_names(c("condition", "tma1", "tma2", "which_model")) %>%
                inner_join(all_layouts, by = "condition")

all_tmas $compound %>% unique() %>% length()

p_glance <- all_tmas %>%
  filter(which_model == "s2_list") %>%
                ggplot(aes(x = compound_conc, y = tma1)) +
                geom_point() +
  facet_wrap(~compound)

p_glance

ggsave("p_glance.pdf", p_glance, width = 20, height = 20)

sum_resids <- all_resids %>% 
              unite(plate_number_model, c(plate_number, which_model), remove = FALSE) %>%
              #filter(which_model == "s2_list") %>%
              group_by(which_model) %>%
              mutate(sum_abs_resid = sum(abs(resid))) %>%
              select(plate_number_model, which_model, variable, plate_number, sum_abs_resid) %>%
              ungroup() %>%
              distinct() %>%
              rename(value = sum_abs_resid) %>%

              group_by(plate_number) %>%
               mutate( outlier = if_else(value > get_upper_whisker(IQR_coef = 1.5, quant_col = value), # identify outliers
                                   true = "Rejected",
                                   false = "Retained") )

```



Post analysis cleaning
```{r}
# take one screening list

# take binnned mean of Tma 1 and Tma 2

# re-assign Tma1 and Tma2 based on whichever one a Tma is closer to 

```


Make files necessary to isolate paper 1-relevant experiments
```{r}
# mapping ZINCid to 4-digit tube label
# % triton by experiment
```


Determine DMSO and ADP ribose values from all experiments
```{r}
# extract DMSO and ADP ribose data only

# plot the tmas, grouped by experiment

# group based on buffer and DMSO/ADPribose and average

```

ATP and ADP barely stabilize
```{r}
# extract DMSO and ADP ribose data only

# plot the tmas, grouped by experiment

# group based on buffer and DMSO/ADPribose and average

```


Main figure: Publication-quality ADP, ATP, ADP ribose dose-response figure
```{r}
# panel 1: raw dara

# panel 2: tmas

# statistical tests 

```

SI-quality figure: Triton X-100 destabilizes the protein
```{r}
# panel 1: raw dara

# panel 2: tmas

# statistical tests 

```

SI-quality figure: Higher protein concentrations destabilize the protein
```{r}
# panel 1: raw dara

# panel 2: tmas

# statistical tests 

```

SI-quality figure: dose-response for all paper 1 compounds (60 compounds)
```{r}
# panel 1.1: raw data, for xtal hits

# panel 1.2: raw data, for non xtal hits

# panel 2.1: tmas, for xtal hits

# panel 2.2: tmas, for non xtal hits

# statistical tests: which compounds induce a significant thermal shift?
```

SI-quality figure: Comparison of xtal results and DSF results
```{r}
### Determine:
# fraction enrichment
# statistical test to say how good of a parameter this is 

# panel 1: for primary transition

# panel 2: for secondary transition

# panel 3: for initial fluorescence

# panel 4: for total fluorescence

# panel 5: for BIC

```

Main figure: dose-response for 
```{r}

```

```{r}
# isolate just the experiments which tested both ADP ribose and DMSO
# https://stackoverflow.com/questions/45146688/execute-dplyr-operation-only-if-column-exists

                 # map( . ,   ~rename( .x, compound_new = starts_with("ZINC"))) 
                 # map( . , ~select( .x, -one_of("compound")))
```


Ultimately, move this to hit calling criteria exploration notebook
Does ADP ribose consistently decrease the starting RFU?
```{r}
###### DO NOT DELETE THIS!!!! ######
#### Isolate the relevant data
has_compound_conc_col <-  map( dfs_protein_TAMRA , ~"compound_conc" %in% names(.x)  ) %>% as_vector() # just the channel of interest
ADPr <-  map( dfs_protein_TAMRA ,
                      ~filter(.x,  # for each tibble
                              across(any_of("compound") | any_of("ZINC"), # if there's a compound or ZINC column
                               ~.x == c("ADPribose")) )) %>% # keep ADPr
          map(. , ~mutate_all(.x, as.character)) %>%
          .[has_compound_conc_col] %>%
          map(. , ~select(.x, c(Temperature, plate_number, value, compound_conc)) ) %>%
          bind_rows() %>%
          unite("plate_compound_conc", # name of new column
                        plate_number, compound_conc, # unite these
                        remove = FALSE) %>%
          mutate_all( . ,convert_numerics) %>% # this misses the compond conc column--is it because of decimal places??
          mutate_at( . ,"compound_conc", as.numeric)

#### Calculate correlation statstics--------
ADPr_25_stats <- ADPr %>%
                filter(Temperature == 25) %>%
                group_by(plate_number) %>%
                nest() %>%
                  mutate(
                  test = map(data, ~ cor.test(.x$compound_conc, .x$value)), # S3 list-col
                  tidied = map(test, broom::tidy)) %>%
                unnest(tidied)

##### Make the facet plat ---------
experiment_labs <- paste0("Experiment ", 1:10)
names(experiment_labs) <- ADPr$plate_number %>% unique()

experiment_labs

ADPr_vs_starting_val <- ADPr %>%
  filter(Temperature == 25,
         !plate_number %in% c("Exp0866_plate1", "Exp0866_plate2")) %>%
                          ggplot(aes(x = compound_conc, y = value)) +
                          geom_jitter( aes(group = plate_compound_conc), alpha = 0.5) +
                           scale_x_continuous(trans = "log2", breaks = c(0, 10, 100,1000))  +
                           facet_wrap(~plate_number,
                                      labeller = labeller(plate_number = experiment_labs),
                                      ncol = 4) +
                            theme_bw() +
  geom_boxplot(aes(group = plate_compound_conc), width = 1,  outlier.shape = NA, alpha = 0.5) +
  geom_text(data = ADPr_25_stats %>% 
                  filter(!plate_number %in% c("Exp0866_plate1", "Exp0866_plate2")), 
            aes(x = 7, y = 8700, label = paste0("p = ", p.value %>% round(2)))) +
  raincloud_theme +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(c(0, 10050))+
  labs(title = "Initial RFU not correlated with [ADP ribose]\nAcross 8 independent experiments\n(Pearson's Correllation Coefficient> 0.05)",
       y = "RFU (TAMRA, 535/580 nm)",
       x = "[ADP ribose] (µM)") 


ggsave("cleaned_analysis/Exp0879--20200913_starting_RFU_ADPr_not_correlated.pdf", ADPr_vs_starting_val, width = 7, height = 4)
```
